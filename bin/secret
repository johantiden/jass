#!/usr/bin/env bash
set -e

CMD="${1}"

function require {
    if ! command -v "${1}" &> /dev/null; then
        echo "COMMAND could not be found"
        exit
    fi
}

require pass
require rq
require jq

function usage {
    echo "Usage: secret COMMAND [ARGS]"
    echo "Example: secret add github  # this will interactively help you add your credentials"
    echo "Example: secret github user"
    echo "Example: secret github pass"
}

function secret-get {
    local PASSPATH="${1}"
    local KEY="${2}"
    if [[ "${KEY}" == "pass" ]]; then
        pass "${PASSPATH}" | head -1
    else 
        pass "${PASSPATH}" | tail +2 | rq -y | jq -r ".${KEY}"
    fi
}

function secret-add {
    local PASSPATH="${1}"
    local USER="${2}"
    local PASS="${3}"

    if [[ "${PASSPATH}" == "" ]]; then
        read -p 'path: ' PASSPATH
    fi
    echo "PASSPATH: ${PASSPATH}"

    if [[ "${USER}" == "" ]]; then
        read -p 'user: ' USER
    fi
    if [[ "${PASS}" == "" ]]; then
        read -sp 'pass: ' PASS
    fi

    echo
    
    {
        echo "${PASS}"
        echo "user: ${USER}"
    } | pass insert -fm "${PASSPATH}" &> /dev/null

}

if [[ "${CMD}" == "" ]]; then
    usage
elif [[ "${CMD}" == "add" ]]; then
    secret-add "${2:-}"
else
    secret-get "${@}"
fi


